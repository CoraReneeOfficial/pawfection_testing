{% extends 'base.html' %}

{% block title %}Receipts Management{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  .search-bar { max-width: 400px; margin: 2rem auto 1rem auto; display: flex; gap: 0.5rem; }
  .receipt-table { width: 100%; border-collapse: collapse; margin: 0 auto; }
  .receipt-table th, .receipt-table td { padding: 0.6em 1em; border-bottom: 1px solid #eee; }
  .receipt-table th { background: #f6f6f6; color: #5c4d7d; }
  .receipt-table tr:hover { background: #f1f1fa; }
  .receipt-actions button { margin-right: 0.3em; }

  .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 20px; align-items: center; }
  .pagination a, .pagination span { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #5c4d7d; background: white; }
  .pagination a:hover { background-color: #f1f1fa; border-color: #d1d1e0; }
  .pagination .active { background-color: #5c4d7d; color: white; border-color: #5c4d7d; }
  .pagination .disabled { color: #ccc; pointer-events: none; border-color: #eee; background: #f9f9f9; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h1>Receipts Management</h1>
  <form class="search-bar" method="GET" action="{{ url_for('appointments.receipts_management') }}" style="flex-wrap: wrap; gap: 0.5rem 1rem;">
    <input type="text" name="q" placeholder="Search by customer, pet, date, or total..." value="{{ request.args.get('q', '') }}" class="input">
    <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}" class="input" title="Start date">
    <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}" class="input" title="End date">
    <input type="number" step="0.01" name="min_total" value="{{ request.args.get('min_total', '') }}" class="input" style="width:110px" placeholder="Min $" title="Min total">
    <input type="number" step="0.01" name="max_total" value="{{ request.args.get('max_total', '') }}" class="input" style="width:110px" placeholder="Max $" title="Max total">
    <button type="submit" class="button button-primary"><i class="fas fa-search"></i> Filter</button>
  </form>
  <table class="receipt-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Customer</th>
        <th>Pet</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in receipts %}
      <tr>
        <td>{{ r['date'] }}</td>
        <td>{{ r['customer_name'] }}</td>
        <td>{{ r['pet_name'] }}</td>
        <td>${{ '%.2f'|format(r['final_total']) }}</td>
        <td class="receipt-actions">
          <!-- View Receipt Button -->
          <a href="{{ url_for('appointments.view_receipt', receipt_id=r['id']) }}" class="button button-secondary" title="View" style="display: inline-block; margin-right: 5px;"><i class="fas fa-eye"></i> View</a>
          
          <!-- Print Receipt Button -->
          <a href="{{ url_for('appointments.print_receipt', receipt_id=r['id']) }}" class="button button-secondary" title="Print" target="_blank" style="display: inline-block; margin-right: 5px;"><i class="fas fa-print"></i> Print</a>
          
          <!-- Email Receipt Form -->
          <form action="{{ url_for('appointments.email_receipt_by_id', receipt_id=r['id']) }}" method="POST" style="display:inline-block; margin-right: 5px;">
            <input type="email" name="email" placeholder="Email" required style="width:130px; padding:2px 6px; font-size:0.95em; display:inline-block;">
            <button type="submit" class="button button-primary" title="Email"><i class="fas fa-envelope"></i> Send</button>
          </form>
          
          <!-- Download Receipt Button -->
          <a href="{{ url_for('appointments.download_receipt', receipt_id=r['id']) }}" class="button button-secondary" title="Download" style="display: inline-block; margin-right: 5px;"><i class="fas fa-download"></i> Download</a>
          
          <!-- Export PDF Button -->
          <a href="{{ url_for('appointments.export_receipt_pdf', receipt_id=r['id']) }}" class="button button-secondary" title="Export PDF" style="display: inline-block;"><i class="fas fa-file-pdf"></i> PDF</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="5" style="text-align:center;color:#888;">No receipts found.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination Controls -->
  {% if pagination and pagination.pages > 1 %}
  <div class="pagination">
    <!-- Previous Page -->
    {% if pagination.has_prev %}
      <a href="{{ url_for('appointments.receipts_management', page=pagination.prev_num, q=request.args.get('q'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), min_total=request.args.get('min_total'), max_total=request.args.get('max_total')) }}">&laquo; Prev</a>
    {% else %}
      <span class="disabled">&laquo; Prev</span>
    {% endif %}

    <!-- Page Numbers -->
    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if pagination.page == page_num %}
          <span class="active">{{ page_num }}</span>
        {% else %}
          <a href="{{ url_for('appointments.receipts_management', page=page_num, q=request.args.get('q'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), min_total=request.args.get('min_total'), max_total=request.args.get('max_total')) }}">{{ page_num }}</a>
        {% endif %}
      {% else %}
        <span class="disabled">...</span>
      {% endif %}
    {% endfor %}

    <!-- Next Page -->
    {% if pagination.has_next %}
      <a href="{{ url_for('appointments.receipts_management', page=pagination.next_num, q=request.args.get('q'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), min_total=request.args.get('min_total'), max_total=request.args.get('max_total')) }}">Next &raquo;</a>
    {% else %}
      <span class="disabled">Next &raquo;</span>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
