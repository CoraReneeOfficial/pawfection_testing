<div id="ai-chat-widget" class="ai-chat-widget" x-data="{ open: false, minimizing: false }" :class="{ 'open': open, 'minimized': minimizing }">
    <!-- Floating Action Button -->
    <button class="ai-fab" @click="open = !open; minimizing = false" aria-label="Pawfection AI Assistant">
        <span x-show="!open">âœ¨ AI Help</span>
        <span x-show="open">&times;</span>
    </button>

    <!-- Chat Window -->
    <div class="ai-chat-window" x-show="open" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-4">
        <div class="ai-chat-header">
            <h3>Pawfection AI</h3>
            <div class="ai-chat-controls">
                <button @click="clearChat()" class="new-chat-btn" title="New Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                    </svg>
                    New Chat
                </button>
                <button @click="open = false; minimizing = true" class="minimize-btn" title="Minimize">_</button>
            </div>
        </div>

        <div class="ai-chat-messages" id="ai-messages">
            <div class="message ai-message">
                Hello! I'm your Pawfection assistant. How can I help you today?
                <br><br>
                Try asking:
                <ul>
                    <li>"Book a bath for Rex tomorrow"</li>
                    <li>"Add a new owner named Sarah"</li>
                    <li>"Show me today's schedule"</li>
                </ul>
            </div>
        </div>

        <div class="ai-chat-input-area">
            <textarea id="ai-user-input" placeholder="Type your request..." rows="1" @keydown.enter.prevent="sendMessage()"></textarea>
            <button class="send-btn" @click="sendMessage()" aria-label="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<style>
    .ai-chat-widget {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 9999;
        font-family: 'Inter', sans-serif;
    }

    .ai-fab {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 0.8rem 1.5rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .ai-fab:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
    }

    .ai-chat-window {
        position: absolute;
        bottom: 4rem;
        right: 0;
        width: 350px;
        height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }

    .ai-chat-header {
        background: #f9fafb;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .ai-chat-header h3 {
        margin: 0;
        font-size: 1rem;
        color: #111827;
        font-weight: 600;
    }

    .ai-chat-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .new-chat-btn {
        background: none;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
        color: #4b5563;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        transition: background 0.2s;
    }

    .new-chat-btn:hover {
        background: #f3f4f6;
    }

    .minimize-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #6b7280;
    }

    .ai-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        background: #fff;
    }

    .message {
        max-width: 85%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .ai-message {
        background: #f3f4f6;
        color: #1f2937;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }

    .ai-message a {
        color: #6366f1;
        font-weight: 500;
        text-decoration: underline;
    }

    .ai-message ul {
        margin: 0.5rem 0 0 1.2rem;
        padding: 0;
    }

    .user-message {
        background: #6366f1;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    .ai-chat-input-area {
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 0.5rem;
        background: #fff;
    }

    #ai-user-input {
        flex: 1;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        resize: none;
        outline: none;
        font-family: inherit;
    }

    #ai-user-input:focus {
        border-color: #6366f1;
    }

    .send-btn {
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }

    .send-btn:hover {
        background: #4f46e5;
    }

    /* Loading Indicator */
    .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
        margin: 0 2px;
    }

    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>

<script>
    let chatHistory = [];

    // Load history on mount
    document.addEventListener('DOMContentLoaded', () => {
        const savedHistory = sessionStorage.getItem('pawfection_ai_history');
        if (savedHistory) {
            try {
                const history = JSON.parse(savedHistory);
                if (history && history.length > 0) {
                    // Clear default welcome message
                    document.getElementById('ai-messages').innerHTML = '';
                    chatHistory = history;
                    history.forEach(msg => {
                        addMessageToUI(msg.text, msg.role === 'user' ? 'user' : 'ai', msg.role === 'model'); // Model responses can be HTML
                    });
                }
            } catch (e) {
                console.error("Failed to parse chat history");
            }
        }
    });

    function saveHistory() {
        sessionStorage.setItem('pawfection_ai_history', JSON.stringify(chatHistory));
    }

    function clearChat() {
        chatHistory = [];
        sessionStorage.removeItem('pawfection_ai_history');
        const messagesDiv = document.getElementById('ai-messages');
        messagesDiv.innerHTML = `
            <div class="message ai-message">
                Hello! I'm your Pawfection assistant. How can I help you today?
                <br><br>
                Try asking:
                <ul>
                    <li>"Book a bath for Rex tomorrow"</li>
                    <li>"Add a new owner named Sarah"</li>
                    <li>"Show me today's schedule"</li>
                </ul>
            </div>
        `;
    }

    function sendMessage() {
        const input = document.getElementById('ai-user-input');
        const message = input.value.trim();
        if (!message) return;

        // If history was empty, clear the default welcome message before adding user msg
        if (chatHistory.length === 0) {
            document.getElementById('ai-messages').innerHTML = '';
        }

        // Add user message
        addMessageToUI(message, 'user');
        chatHistory.push({ role: 'user', text: message });
        saveHistory();

        input.value = '';

        // Show loading
        const loadingId = addLoading();

        // Send to backend
        fetch('{{ url_for("ai_assistant.chat") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ message: message, history: chatHistory.slice(0, -1) }) // Send history excluding current msg
        })
        .then(response => response.json())
        .then(data => {
            removeLoading(loadingId);
            if (data.error) {
                addMessageToUI('Error: ' + data.error, 'ai');
            } else {
                addMessageToUI(data.response, 'ai', true);
                chatHistory.push({ role: 'model', text: data.response }); // Note: storing HTML response in history for now, text is fine since we display it as HTML anyway
                saveHistory();
            }
        })
        .catch(error => {
            removeLoading(loadingId);
            addMessageToUI('Sorry, something went wrong. Please check your connection.', 'ai');
            console.error('Error:', error);
        });
    }

    function addMessageToUI(text, sender, isHtml = false) {
        const messagesDiv = document.getElementById('ai-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-message`;

        if (isHtml) {
            msgDiv.innerHTML = text;
        } else {
            msgDiv.textContent = text;
        }

        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addLoading() {
        const messagesDiv = document.getElementById('ai-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ai-message typing-indicator';
        msgDiv.id = 'ai-loading-' + Date.now();
        msgDiv.innerHTML = '<span></span><span></span><span></span>';
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return msgDiv.id;
    }

    function removeLoading(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }
</script>
