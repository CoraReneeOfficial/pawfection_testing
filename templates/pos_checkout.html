{% extends 'base.html' %}

{% block title %}Checkout - POS{% endblock %}

{% block head %}
<style>
/* POS Checkout Layout */
.pos-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 80px); /* Adjust based on your header height */
    max-width: 1400px;
    margin: 0 auto;
    overflow: hidden;
    background: #f8fafc;
}

@media (min-width: 992px) {
    .pos-container {
        flex-direction: row;
    }
}

/* Left Pane: Appointments */
.pos-left-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    border-right: 1px solid var(--border-color);
    overflow: hidden;
}

.pos-left-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    background: white;
    z-index: 10;
}

.pos-quick-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.pos-quick-actions .button {
    flex: 1;
    padding: 0.75rem 0.5rem;
    font-size: 0.9rem;
    text-align: center;
}

.pos-search-bar {
    display: flex;
    gap: 0.5rem;
}

.pos-search-bar input {
    flex: 1;
}

.pos-appointments-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    margin: 0;
    list-style: none;
    background: #f1f5f9;
}

.pos-appointment-item {
    padding: 1rem;
    border-bottom: 1px solid #e2e8f0;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
}

.pos-appointment-item:hover {
    background: #f8fafc;
}

.pos-appointment-item.selected {
    background: #eff6ff;
    border-left: 4px solid var(--primary-color);
}

.pos-appointment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.pos-appointment-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text-color);
}

.pos-appointment-time {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.pos-appointment-details {
    font-size: 0.9rem;
    color: var(--text-muted);
}

.pos-appointment-deposit {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--secondary-color);
    font-weight: 600;
}

/* Right Pane: Cart */
.pos-right-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
}

@media (min-width: 992px) {
    .pos-right-pane {
        flex: 1.2;
    }
}

.pos-cart-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: white;
}

.pos-cart-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.pos-cart-subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin: 0.25rem 0 0 0;
}

.pos-cart-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.pos-cart-items {
    list-style: none;
    padding: 0;
    margin: 0;
}

.pos-cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px dashed var(--border-color);
}

.pos-cart-item-info {
    flex: 1;
}

.pos-cart-item-name {
    font-weight: 500;
    color: var(--text-color);
}

.pos-cart-item-type {
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
}

.pos-cart-item-price {
    font-weight: 600;
}

.pos-cart-item-remove {
    color: var(--danger-color, #ef4444);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    margin-left: 0.5rem;
}

.pos-add-items {
    margin-top: 1.5rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.pos-add-items select {
    flex: 1;
    min-width: 200px;
}

/* Cart Footer / Totals */
.pos-cart-footer {
    padding: 1.5rem;
    border-top: 2px solid var(--border-color);
    background: #f8fafc;
}

.pos-totals-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    color: var(--text-color);
}

.pos-totals-row.deposit-row {
    color: var(--secondary-color);
}

.pos-totals-row.discount-row {
    color: #ef4444;
}

.pos-totals-row.grand-total {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #cbd5e1;
}

.pos-charge-button {
    width: 100%;
    padding: 1.25rem;
    font-size: 1.25rem;
    font-weight: 700;
    border-radius: 0.5rem;
    margin-top: 1rem;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.pos-charge-button:hover:not(:disabled) {
    background: var(--primary-hover);
}

.pos-charge-button:disabled {
    background: #94a3b8;
    cursor: not-allowed;
}

/* Discount and Custom Item Modals */
.pos-modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.pos-modal {
    background: white;
    padding: 2rem;
    border-radius: var(--border-radius);
    width: 100%;
    max-width: 400px;
}

.pos-empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
}
.pos-empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #cbd5e1;
}
</style>
{% endblock %}

{% block content %}
<div class="pos-container" x-data="posCheckout()">

    <!-- Left Pane: Appointments -->
    <div class="pos-left-pane">
        <div class="pos-left-header">
            <div class="pos-quick-actions">
                <a href="{{ url_for('appointments.walk_in_appointment') }}" class="button button-primary">
                    <i class="fas fa-user-plus"></i> Walk-In
                </a>
                <a href="{{ url_for('appointments.deposit_payment') }}" class="button button-secondary">
                    <i class="fas fa-money-bill"></i> Deposit
                </a>
            </div>
            <div class="pos-search-bar">
                <input type="text" x-model="searchQuery" class="form-input" placeholder="Search customer or pet...">
            </div>
        </div>

        <ul class="pos-appointments-list">
            {% for appt in appointments %}
            <li class="pos-appointment-item"
                x-show="matchesSearch('{{ appt.dog.owner.name|lower }}', '{{ appt.dog.name|lower }}')"
                :class="{'selected': selectedAppointmentId === {{ appt.id }} }"
                @click="loadAppointment({{ appt.id }})">
                <div class="pos-appointment-header">
                    <div class="pos-appointment-name">{{ appt.dog.name }} ({{ appt.dog.owner.name }})</div>
                    <div class="pos-appointment-time">{{ appt.appointment_datetime.strftime('%I:%M %p') }}</div>
                </div>
                <div class="pos-appointment-details">
                    {% if appt.groomer %}Groomer: {{ appt.groomer.username }}<br>{% endif %}
                    {% if appt.requested_services_text %}Services: {{ appt.requested_services_text|service_names_from_ids }}{% endif %}
                </div>
                {% if appt.deposit_amount and appt.deposit_amount > 0 %}
                <div class="pos-appointment-deposit">
                    <i class="fas fa-check-circle"></i> Deposit Paid: ${{ "%.2f"|format(appt.deposit_amount) }}
                </div>
                {% endif %}
            </li>
            {% else %}
            <li class="pos-empty-state">
                <i class="far fa-calendar-check"></i>
                <p>No appointments scheduled today.</p>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Right Pane: Cart/Checkout -->
    <div class="pos-right-pane">
        <!-- Empty State (No appointment selected) -->
        <div x-show="!selectedAppointmentId" class="pos-empty-state" style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
            <i class="fas fa-shopping-cart"></i>
            <h2>Select an appointment</h2>
            <p>Choose an appointment from the left to start checkout.</p>
        </div>

        <!-- Checkout Form / Cart -->
        <form x-show="selectedAppointmentId"
              method="POST"
              action="{{ url_for('appointments.pos_checkout') }}"
              id="checkout-form"
              style="display: flex; flex-direction: column; height: 100%;"
              x-cloak>

            <input type="hidden" name="appointment_id" :value="selectedAppointmentId">
            <input type="hidden" name="line_items" :value="JSON.stringify(
                discountAmount > 0
                ? [...cart, {name: discountName || 'Discount', price: -discountAmount, type: 'discount'}]
                : cart
            )">
            <input type="hidden" name="subtotal" :value="subtotal.toFixed(2)">
            <input type="hidden" name="taxes" :value="taxes.toFixed(2)">
            <input type="hidden" name="deposit_deduction" :value="depositAmount.toFixed(2)">
            <input type="hidden" name="total" :value="total.toFixed(2)">

            <div class="pos-cart-header">
                <h2 class="pos-cart-title" x-text="customerName ? customerName + ' - ' + petName : 'Loading...'"></h2>
                <p class="pos-cart-subtitle" x-text="appointmentDate"></p>
            </div>

            <div class="pos-cart-body">
                <ul class="pos-cart-items">
                    <template x-for="(item, index) in cart" :key="index">
                        <li class="pos-cart-item">
                            <div class="pos-cart-item-info">
                                <div class="pos-cart-item-name" x-text="item.name"></div>
                                <div class="pos-cart-item-type" x-text="item.type"></div>
                            </div>
                            <div class="pos-cart-item-price" x-text="'$' + (parseFloat(item.price)).toFixed(2)"></div>
                            <button type="button" class="pos-cart-item-remove" @click="removeFromCart(index)" title="Remove">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </li>
                    </template>
                </ul>

                <div x-show="cart.length === 0" class="text-muted" style="margin-top: 1rem; text-align: center;">
                    No items in cart.
                </div>

                <div class="pos-add-items">
                    <div style="flex: 1; display: flex; gap: 0.5rem;">
                        <select x-model="selectedServiceToAdd" class="form-input">
                            <option value="">-- Add Service --</option>
                            {% for service in services %}
                            <option value="{{ service.id }}" data-name="{{ service.name }}" data-price="{{ service.base_price }}">{{ service.name }} (${{ "%.2f"|format(service.base_price) }})</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="button button-primary" @click="addServiceToCart()">Add</button>
                    </div>
                </div>

                <div class="pos-add-items">
                    <div style="flex: 1; display: flex; gap: 0.5rem;">
                        <select x-model="selectedFeeToAdd" class="form-input">
                            <option value="">-- Add Fee --</option>
                            {% for fee in fees %}
                            <option value="{{ fee.id }}" data-name="{{ fee.name }}" data-price="{{ fee.base_price }}">{{ fee.name }} (${{ "%.2f"|format(fee.base_price) }})</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="button button-primary" @click="addFeeToCart()">Add</button>
                    </div>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button type="button" class="button button-secondary" @click="showCustomModal = true" style="flex: 1;">
                        <i class="fas fa-plus"></i> Custom Item
                    </button>
                    <button type="button" class="button button-secondary" @click="showDiscountModal = true" style="flex: 1;">
                        <i class="fas fa-tag"></i> Add Discount
                    </button>
                </div>
            </div>

            <div class="pos-cart-footer">
                <div class="pos-totals-row">
                    <span>Subtotal</span>
                    <span x-text="'$' + subtotal.toFixed(2)"></span>
                </div>

                <div class="pos-totals-row discount-row" x-show="discountAmount > 0">
                    <span x-text="discountName || 'Discount'"></span>
                    <span x-text="'-$' + discountAmount.toFixed(2)"></span>
                </div>

                <div class="pos-totals-row deposit-row" x-show="depositAmount > 0">
                    <span>Deposit Applied</span>
                    <span x-text="'-$' + depositAmount.toFixed(2)"></span>
                </div>

                <div class="pos-totals-row" x-show="{{ 'true' if tax_enabled else 'false' }}">
                    <span>Tax ({{ (tax_rate * 100)|int }}%)</span>
                    <span x-text="'$' + taxes.toFixed(2)"></span>
                </div>

                <div class="pos-totals-row grand-total">
                    <span>Total Due</span>
                    <span x-text="'$' + Math.max(0, total).toFixed(2)"></span>
                </div>

                <button type="submit" class="pos-charge-button" :disabled="cart.length === 0">
                    Charge <span x-text="'$' + Math.max(0, total).toFixed(2)"></span>
                </button>
            </div>
        </form>
    </div>

    <!-- Custom Item Modal -->
    <div class="pos-modal-overlay" :style="showCustomModal ? 'display: flex' : 'display: none'">
        <div class="pos-modal">
            <h3>Add Custom Item</h3>
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" x-model="customItemName" class="form-input" placeholder="e.g. Special Shampoo">
            </div>
            <div class="form-group">
                <label>Price ($)</label>
                <input type="number" x-model.number="customItemPrice" class="form-input" step="0.01" min="0">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="button button-primary" style="flex: 1;" @click="addCustomItem()">Add</button>
                <button type="button" class="button button-secondary" style="flex: 1;" @click="showCustomModal = false">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Discount Modal -->
    <div class="pos-modal-overlay" :style="showDiscountModal ? 'display: flex' : 'display: none'">
        <div class="pos-modal">
            <h3>Add Discount</h3>
            <div class="form-group">
                <label>Discount Name (Optional)</label>
                <input type="text" x-model="discountInputName" class="form-input" placeholder="e.g. Loyalty">
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button type="button" class="button" :class="discountType === 'amount' ? 'button-primary' : 'button-secondary'" style="flex: 1;" @click="discountType = 'amount'">$ Amount</button>
                <button type="button" class="button" :class="discountType === 'percent' ? 'button-primary' : 'button-secondary'" style="flex: 1;" @click="discountType = 'percent'">% Percent</button>
            </div>
            <div class="form-group">
                <label x-text="discountType === 'amount' ? 'Amount ($)' : 'Percentage (%)'"></label>
                <input type="number" x-model.number="discountInputValue" class="form-input" :step="discountType === 'amount' ? '0.01' : '1'" min="0">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="button button-primary" style="flex: 1;" @click="applyDiscount()">Apply</button>
                <button type="button" class="button button-secondary" style="flex: 1;" @click="removeDiscount()">Remove</button>
                <button type="button" class="button button-secondary" style="flex: 1;" @click="showDiscountModal = false">Cancel</button>
            </div>
        </div>
    </div>

</div>

<script>
function posCheckout() {
    return {
        searchQuery: '',
        selectedAppointmentId: null,
        customerName: '',
        petName: '',
        appointmentDate: '',

        cart: [],
        subtotal: 0,
        taxes: 0,
        total: 0,

        depositAmount: 0,

        // Add item state
        selectedServiceToAdd: '',
        selectedFeeToAdd: '',

        // Custom item modal
        showCustomModal: false,
        customItemName: '',
        customItemPrice: 0,

        // Discount modal
        showDiscountModal: false,
        discountType: 'amount', // 'amount' or 'percent'
        discountInputValue: 0,
        discountInputName: '',
        discountAmount: 0,
        discountName: '',

        taxEnabled: {{ 'true' if tax_enabled else 'false' }},
        taxRate: {{ tax_rate }},

        matchesSearch(ownerName, dogName) {
            if (!this.searchQuery) return true;
            const q = this.searchQuery.toLowerCase();
            return ownerName.includes(q) || dogName.includes(q);
        },

        async loadAppointment(id) {
            this.selectedAppointmentId = id;
            this.cart = [];
            this.discountAmount = 0;
            this.discountName = '';

            try {
                const response = await fetch(`/checkout/api/appointment/${id}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                this.customerName = data.customer_name;
                this.petName = data.pet_name;
                this.appointmentDate = data.date;
                this.depositAmount = data.deposit_amount || 0;

                // Pre-populate requested services if possible
                // (Requires grabbing the select options by value to get price/name)
                if (data.requested_service_ids && data.requested_service_ids.length > 0) {
                    const serviceSelect = document.querySelector('select[x-model="selectedServiceToAdd"]');
                    data.requested_service_ids.forEach(sid => {
                        const option = serviceSelect.querySelector(`option[value="${sid}"]`);
                        if (option) {
                            this.cart.push({
                                id: sid,
                                name: option.dataset.name,
                                price: parseFloat(option.dataset.price),
                                type: 'service'
                            });
                        }
                    });
                }

                this.calculateTotals();
            } catch (error) {
                console.error("Error fetching appointment:", error);
                alert("Failed to load appointment details.");
            }
        },

        addServiceToCart() {
            if (!this.selectedServiceToAdd) return;
            const select = document.querySelector('select[x-model="selectedServiceToAdd"]');
            const option = select.options[select.selectedIndex];

            this.cart.push({
                id: this.selectedServiceToAdd,
                name: option.dataset.name,
                price: parseFloat(option.dataset.price),
                type: 'service'
            });

            this.selectedServiceToAdd = '';
            this.calculateTotals();
        },

        addFeeToCart() {
            if (!this.selectedFeeToAdd) return;
            const select = document.querySelector('select[x-model="selectedFeeToAdd"]');
            const option = select.options[select.selectedIndex];

            this.cart.push({
                id: this.selectedFeeToAdd,
                name: option.dataset.name,
                price: parseFloat(option.dataset.price),
                type: 'fee'
            });

            this.selectedFeeToAdd = '';
            this.calculateTotals();
        },

        addCustomItem() {
            if (!this.customItemName.trim() || this.customItemPrice < 0) {
                alert("Please enter a valid name and price.");
                return;
            }
            this.cart.push({
                name: this.customItemName,
                price: parseFloat(this.customItemPrice),
                type: 'custom'
            });
            this.showCustomModal = false;
            this.customItemName = '';
            this.customItemPrice = 0;
            this.calculateTotals();
        },

        applyDiscount() {
            if (this.discountInputValue < 0) {
                alert("Discount cannot be negative.");
                return;
            }
            if (this.discountType === 'percent' && this.discountInputValue > 100) {
                alert("Discount percentage cannot exceed 100%.");
                return;
            }

            this.discountAmount = 0; // Temporarily reset to calculate pure subtotal
            this.calculateTotals();

            if (this.discountType === 'percent') {
                this.discountAmount = parseFloat((this.subtotal * (this.discountInputValue / 100)).toFixed(2));
            } else {
                this.discountAmount = parseFloat(this.discountInputValue);
            }

            this.discountName = this.discountInputName || (this.discountType === 'percent' ? `${this.discountInputValue}% Discount` : 'Discount');

            this.showDiscountModal = false;
            this.calculateTotals();
        },

        removeDiscount() {
            this.discountAmount = 0;
            this.discountName = '';
            this.discountInputValue = 0;
            this.showDiscountModal = false;
            this.calculateTotals();
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);

            // Re-evaluate discount if it's a percentage
            if (this.discountAmount > 0 && this.discountType === 'percent') {
                let pureSubtotal = this.cart.reduce((sum, item) => sum + item.price, 0);
                this.discountAmount = parseFloat((pureSubtotal * (this.discountInputValue / 100)).toFixed(2));
            }

            this.calculateTotals();
        },

        calculateTotals() {
            // Raw subtotal of cart items
            this.subtotal = this.cart.reduce((sum, item) => sum + item.price, 0);

            // Apply discount
            let discountedSubtotal = Math.max(0, this.subtotal - this.discountAmount);

            // Calculate taxes on discounted subtotal
            if (this.taxEnabled) {
                this.taxes = parseFloat((discountedSubtotal * this.taxRate).toFixed(2));
            } else {
                this.taxes = 0;
            }

            // Grand total before deposit
            let totalBeforeDeposit = discountedSubtotal + this.taxes;

            // Apply deposit
            this.total = Math.max(0, totalBeforeDeposit - this.depositAmount);

            // IMPORTANT: If we are submitting, we want to inject the discount as a negative line item
            // This is handled on the backend based on `subtotal` and `total`, or we can add it to cart
            // on form submit. The backend expects line_items to contain everything.
        }
    }
}

// Alpine v2 compatible approach
document.addEventListener('alpine:init', () => {
    // We don't need this in v2 usually, but for safe measure since base.html loads Alpine via script tag.
});
</script>
{% endblock %}