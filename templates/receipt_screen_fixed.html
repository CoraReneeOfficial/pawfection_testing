{% extends 'base.html' %}

{% block title %}Receipt - Checkout Complete{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  .receipt-success { text-align: center; margin: 2.5rem 0 2rem 0; }
  .receipt-success .fa-check-circle { color: var(--success-color); font-size: 3.5em; margin-bottom: 0.5rem; }
  .receipt-options { display: flex; gap: 1.2rem; justify-content: center; margin: 2rem 0 1.5rem 0; }
  .receipt-btn { min-width: 140px; font-size: 1.05em; }
  @media print {
    body * { visibility: hidden !important; }
    #printable-receipt, #printable-receipt * { visibility: visible !important; }
    #printable-receipt { position: absolute; left: 0; top: 0; width: 100vw; background: white; box-shadow: none; }
    .receipt-options, .button, form[action*="dashboard"] { display: none !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container checkout-container">
  <div class="receipt-success">
    <i class="fas fa-check-circle"></i>
    <h1>Checkout Complete!</h1>
    <p>Thank you for your business.</p>
  </div>
  <div class="receipt-content" id="printable-receipt">
    <div class="receipt-container" style="max-width:480px;margin:auto;">
      <div class="header" style="text-align:center;margin-bottom:1.5rem;">
        <h1>{{ store_name }}</h1>
        <p>Thank you for your business!</p>
      </div>
      <div>
        <strong>Date:</strong> {{ date }}<br>
        <strong>Customer:</strong> {{ customer_name }}<br>
        <strong>Pet:</strong> {{ pet_name }}<br>
      </div>
      <div class="line-items" style="margin-bottom:1.2rem;">
        <h3 style="margin-bottom:0.4em;">Services & Products</h3>
        {% for item in line_items %}
        <div class="line-item" style="display:flex;justify-content:space-between;margin-bottom:0.4em;">
          <span>{{ item.name }}</span>
          <span>${{ '%.2f'|format(item.price) }}</span>
        </div>
        {% endfor %}
      </div>
      <div class="totals" style="margin-top:1.2rem;border-top:1px solid #eee;padding-top:0.7rem;">
        <div class="totals-row" style="display:flex;justify-content:space-between;margin-bottom:0.2em;font-size:1.06em;">
          <span>Subtotal:</span><span>${{ '%.2f'|format(subtotal) }}</span>
        </div>
        <div class="totals-row" style="display:flex;justify-content:space-between;margin-bottom:0.2em;font-size:1.06em;">
          <span>Taxes:</span><span>${{ '%.2f'|format(taxes) }}</span>
        </div>
        <div class="totals-row" style="display:flex;justify-content:space-between;margin-bottom:0.2em;font-size:1.06em;">
          <span>Tip:</span><span>${{ '%.2f'|format(tip) }}</span>
        </div>
        <div class="totals-row total" style="font-weight:bold;color:#5c4d7d;font-size:1.13em;display:flex;justify-content:space-between;">
          <span>Total:</span><span>${{ '%.2f'|format(total) }}</span>
        </div>
      </div>
      <div class="footer" style="text-align:center;color:#888;font-size:0.97em;margin-top:2rem;">
        Receipt generated by Pawfection<br>
        {{ store_email }}<br>
        {{ store_phone }}
      </div>
      <div class="receipt-options" style="display:flex;gap:1.2rem;justify-content:center;margin:2rem 0 1.5rem 0;">
        <form method="POST" action="{{ url_for('appointments.email_receipt', appointment_id=appointment_id) }}" style="display:inline;">
          <input type="hidden" name="customer_email" value="{{ customer_email }}">
          <button type="submit" class="button button-primary receipt-btn"><i class="fas fa-envelope"></i> Email Receipt</button>
        </form>
        <button type="button" class="button button-secondary receipt-btn" id="print-receipt-btn" onclick="openPrintableReceipt()"><i class="fas fa-print"></i> Print Receipt</button>
      </div>
      <form method="POST" action="{{ url_for('appointments.finalize_checkout', appointment_id=appointment_id) }}">
        <button type="submit" class="button button-success" style="width:100%;margin:1.4rem 0 0.6rem 0;font-size:1.13em;background:#28a745;">Complete Checkout</button>
      </form>
      <form method="GET" action="{{ url_for('dashboard') }}">
        <button type="submit" class="button button-primary" style="width:100%;margin-top:0.6rem;font-size:1.08em;">Finish / Back to Dashboard</button>
      </form>
    </div>
  </div>
</div>
<script>
function openPrintableReceipt() {
  window.print();
}
</script>
{% endblock %}
