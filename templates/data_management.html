{% extends 'base.html' %} {# Inherits the base layout, navbar, footer, etc. #}

{% block title %}Data Management{% endblock %} {# Sets the title for this specific page #}

{% block head %}
<style>
    .section-card {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--box-shadow-sm);
    }
    
    .section-card h2 {
        margin-top: 0;
        color: var(--primary-color);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-card .icon {
        font-size: 1.2em;
    }
    
    .export-options, .import-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .export-button {
        display: inline-block;
        background-color: #f0f9ff;
        border: 1px solid #bae6fd;
        color: #0369a1;
        padding: 0.8rem 1rem;
        border-radius: var(--border-radius);
        text-decoration: none;
        transition: background-color 0.2s;
        font-weight: 500;
    }
    
    .export-button:hover {
        background-color: #e0f2fe;
    }
    
    .alert {
        padding: 0.8rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
    }
    
    .alert-warning {
        background-color: #fef3c7;
        border: 1px solid #fde047;
        color: #854d0e;
    }
    
    .alert-info {
        background-color: #e0f2fe;
        border: 1px solid #bae6fd;
        color: #0369a1;
    }
    
    .file-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        margin: 1rem 0;
        transition: border-color 0.2s;
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
    }
    
    .file-upload-area p {
        margin: 0.5rem 0;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %} {# Defines the main content area for this page #}
<div class="content-card">
    <h1>Data Management</h1>
    <p>Export or import your store's data. This includes your database and uploaded images.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="section-card">
        <h2><span class="icon">üì§</span> Export Data</h2>
        <p>Download your store's data for backup or migration purposes.</p>
        
        <div class="export-options">
            <a href="{{ url_for('management.export_database') }}" class="export-button">
                <span class="icon">üíæ</span> Export Database File
            </a>
            <a href="{{ url_for('management.export_images') }}" class="export-button">
                <span class="icon">üñºÔ∏è</span> Export Uploaded Images
            </a>
            <a href="{{ url_for('management.export_all_data') }}" class="export-button">
                <span class="icon">üì¶</span> Export All Data (Database + Images)
            </a>
        </div>
    </div>
    
    {% if g.user and (g.user.role == 'superadmin' or session.get('is_superadmin')) %}
    <div class="section-card">
        <h2><span class="icon">üì•</span> Import Data</h2>
        <p>Import a database file to restore or migrate your store's data.</p>
        
        <div class="alert alert-info">
            <strong>Note:</strong> You can choose to either overwrite your existing data or merge with your current data when importing.
        </div>
        
        <form action="{{ url_for('management.import_database') }}" method="POST" enctype="multipart/form-data">
            {{ form.csrf_token }}
            <div class="file-upload-area">
                <label for="database_file">
                    <span class="icon" style="font-size: 2rem;">üìÑ</span>
                    <p><strong>Click to select or drag & drop database file</strong></p>
                    <p>Only .db files are supported</p>
                </label>
                <input type="file" id="database_file" name="database_file" accept=".db" style="display: none;">
            </div>
            
            <div class="import-options" style="margin: 1.5rem 0;">
                <h3>Import Options:</h3>
                <div style="display: flex; gap: 2rem; margin-top: 0.5rem;">
                    <div>
                        <input type="radio" id="import_mode_overwrite" name="import_mode" value="overwrite" checked>
                        <label for="import_mode_overwrite">
                            <strong>Overwrite</strong> - Replace all existing data
                            <div style="color: var(--text-muted); margin-top: 0.25rem; font-size: 0.9rem;">
                                Clears existing data and starts fresh with imported data
                            </div>
                        </label>
                    </div>
                    <div>
                        <input type="radio" id="import_mode_merge" name="import_mode" value="merge">
                        <label for="import_mode_merge">
                            <strong>Merge</strong> - Add to existing data
                            <div style="color: var(--text-muted); margin-top: 0.25rem; font-size: 0.9rem;">
                                Keeps existing data and adds new data from import, skipping duplicates
                            </div>
                        </label>
                    </div>
                </div>
                <div class="alert alert-warning" style="margin-top: 1rem;">
                    <strong>Warning:</strong> Always export your current data as a backup before importing.
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="button button-primary">Import Database</button>
            </div>
        </form>
    </div>
    {% endif %}

    <div style="margin-top: 2rem;">
        <a href="{{ url_for('management.management') }}" class="button button-secondary">Back to Management</a>
    </div>
</div>

<script>
    // Script to handle file selection display
    document.getElementById('database_file').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        if (fileName) {
            const fileUploadArea = document.querySelector('.file-upload-area p:first-of-type');
            fileUploadArea.innerHTML = `<strong>Selected file:</strong> ${fileName}`;
        }
    });
    
    // Enable drag and drop for file upload
    const fileUploadArea = document.querySelector('.file-upload-area');
    const fileInput = document.getElementById('database_file');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        fileUploadArea.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
        fileUploadArea.style.backgroundColor = '#f8fafc';
    }
    
    function unhighlight() {
        fileUploadArea.style.borderColor = '#cbd5e1';
        fileUploadArea.style.backgroundColor = '';
    }
    
    fileUploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        
        const fileName = files[0]?.name;
        if (fileName) {
            const fileUploadArea = document.querySelector('.file-upload-area p:first-of-type');
            fileUploadArea.innerHTML = `<strong>Selected file:</strong> ${fileName}`;
        }
    }
</script>
{% endblock %}
