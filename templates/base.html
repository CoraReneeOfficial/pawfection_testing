<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Pawfection Grooming Solutions{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v='1.5') }}">
    {% block head %}{% endblock %}
</head>
<body x-data="notificationManager()">
    <div class="page-wrapper">

        {% if g.user %}
        <nav class="main-nav">
            <div class="nav-container">
                <div class="nav-brand">
                    <a href="{{ url_for('dashboard') }}">
                        <span aria-hidden="true">üêæ</span>
                        Pawfection Grooming Solutions
                    </a>
                </div>

                <div class="nav-user-menu-area">
                    <!-- User Picture -->
                    <div class="nav-user-pic">
                        {% if g.user.picture_filename %}
                            <img src="{{ url_for('uploaded_persistent_file', filename=g.user.picture_filename) }}" alt="User profile picture">
                        {% else %}
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="default-user-pic-svg">
                                <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" />
                            </svg>
                        {% endif %}
                    </div>

                    <!-- Notification Button -->
                    <div class="nav-notification">
                        <button type="button" @click.stop="notificationOpen = !notificationOpen; if(notificationOpen) navMenuOpen = false;" class="nav-notification-button" aria-label="Notifications">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="notification-icon">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                            </svg>
                            <!-- Notification Badge -->
                            <span x-show="unreadCount > 0" x-text="unreadCount" class="notification-badge" style="color: black;" x-cloak></span>
                        </button>
                        <!-- Notification Dropdown -->
                        <div class="notification-dropdown" id="notification-dropdown" 
                             x-show="notificationOpen" 
                             @click.outside="notificationOpen = false"
                             x-cloak
                             x-transition:enter="transition ease-out duration-100 transform"
                             x-transition:enter-start="opacity-0 scale-95"
                             x-transition:enter-end="opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75 transform"
                             x-transition:leave-start="opacity-100 scale-100"
                             x-transition:leave-end="opacity-0 scale-95">
                            <div class="notification-header-container">
                                <h3 class="notification-header">Notifications</h3>
                                {% if notifications %}
                                <a href="{{ url_for('notification_system.mark_all_read') }}" class="mark-all-read-btn">Mark All Read</a>
                                {% endif %}
                            </div>
                            {% if notifications %}
                                <div class="notification-list">
                                    {% for notification in notifications %}
                                        <a href="{{ notification.link }}" class="notification-item {% if not notification.is_read %}unread{% endif %}">
                                            <div class="notification-content">
                                                <div class="notification-title">{{ notification.content }}</div>
                                                <div class="notification-time">{{ notification.created_at|timeago }}</div>
                                            </div>
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="no-notifications">No new notifications</div>
                            {% endif %}
                            <div class="notification-footer">
                                <a href="{{ url_for('notification_system.view_all') }}" class="see-all-link">See All</a>
                            </div>
                        </div>
                    </div>


                    <div class="nav-menu-container" @click.outside="navMenuOpen = false">
                        <button @click="navMenuOpen = !navMenuOpen; if(navMenuOpen) notificationOpen = false;" class="nav-menu-button" aria-controls="main-navigation-dropdown" :aria-expanded="navMenuOpen.toString()">
                            <span class="nav-menu-text">Menu</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="nav-menu-chevron" :class="{ 'rotate-180': navMenuOpen }">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div class="nav-dropdown-menu" id="main-navigation-dropdown" x-show="navMenuOpen" x-cloak
                             x-transition:enter="transition ease-out duration-100 transform"
                             x-transition:enter-start="opacity-0 scale-95"
                             x-transition:enter-end="opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75 transform"
                             x-transition:leave-start="opacity-100 scale-100"
                             x-transition:leave-end="opacity-0 scale-95">
                            <a href="{{ url_for('dashboard') }}" class="nav-dropdown-item {% if request.endpoint == 'dashboard' %}active{% endif %}">Dashboard</a>
                            <a href="{{ url_for('owners.directory') }}" class="nav-dropdown-item {% if request.endpoint == 'owners.directory' %}active{% endif %}">Directory</a>
                            <a href="{{ url_for('appointments.calendar_view') }}" class="nav-dropdown-item {% if request.endpoint == 'appointments.calendar_view' %}active{% endif %}">Calendar</a>
                            {% if g.user.is_admin %}
                            <a href="{{ url_for('management.pending_appointments') }}" class="nav-dropdown-item {% if request.endpoint == 'management.pending_appointments' %}active{% endif %}">Pending Appointments</a>
                            {% endif %}
                            <a href="{{ url_for('appointments.checkout_start') }}" class="nav-dropdown-item {% if request.endpoint == 'appointments.checkout_start' %}active{% endif %}">Checkout</a>
                            <a href="{{ url_for('appointments.receipts_management') }}" class="nav-dropdown-item {% if request.endpoint == 'appointments.receipts_management' %}active{% endif %}">Receipts</a>
                            {% if g.user.is_admin %}
                            <a href="{{ url_for('management.management') }}" class="nav-dropdown-item {% if request.endpoint and (request.endpoint == 'management.management' or (request.endpoint.startswith('management.') and request.endpoint != 'management.pending_appointments') or request.endpoint == 'management.view_sales_reports' or request.endpoint == 'management.view_user_agreement' or request.endpoint == 'management.view_privacy_policy') %}active{% endif %}">Management</a>
                            {% endif %}
                            <div class="nav-dropdown-divider"></div>
                            <div class="nav-dropdown-user-info">
                                Hello, {{ g.user.username if g.user else "User" }}!
                            </div>
                            <a href="{{ url_for('auth.logout') }}" class="nav-dropdown-item logout">Logout</a>
                        </div>
                    </div>
                </div> 
            </div>
        </nav>
        {% endif %}

        <div class="flash-messages container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% set category_class = 'flash-' + category if category in ['danger', 'success', 'warning', 'info'] else 'flash-info' %}
                        <div class="flash-message {{ category_class }}" role="alert"
                             x-data="{ show: true }"
                             x-show="show"
                             x-init="setTimeout(() => show = false, 5000)"
                             x-transition:leave="transition ease-in duration-500"
                             x-transition:leave-start="opacity-100"
                             x-transition:leave-end="opacity-0">
                            <p>{{ message }}</p>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <main class="main-content container">
            {% if session.impersonating %}
            <div style="background: #ffe066; color: #333; padding: 1rem; text-align: center; font-weight: bold;">
                Superadmin: Impersonating Store
                <a href="{{ url_for('superadmin_stop_impersonation') }}" class="button button-small button-danger" style="margin-left: 2rem;">Stop Impersonation</a>
            </div>
            {% endif %}
            {% block content %}{% endblock %}
        </main>

        <footer class="main-footer">
            <p>Pawfection Grooming Solutions by Cora Kirkpatrick &copy; {{ now().year if now else "" }}</p>
        </footer>

    </div>

    <!-- Back to Top Button -->
    <button
        x-data="{ show: false }"
        @scroll.window="show = (window.pageYOffset > 300)"
        @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        x-show="show"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-4"
        style="position: fixed; bottom: 80px; right: 20px; z-index: 50; width: 45px; height: 45px; border-radius: 50%; background-color: var(--primary-color); color: white; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;"
        aria-label="Back to Top"
        x-cloak
    >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 24px; height: 24px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
        </svg>
    </button>

    <!-- Notification Popup -->
    <div id="notification-popup"
         class="notification-popup"
         x-data="{ show: false }"
         x-show="popupShow"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="translate-y-2 opacity-0"
         x-transition:enter-end="translate-y-0 opacity-100"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         style="display: none;"
         x-cloak>

        <div class="notification-popup-content" @click="if($event.target.tagName !== 'BUTTON' && currentNotification) window.location.href = currentNotification.link">
            <div class="notification-popup-header">
                <strong x-text="currentNotification ? currentNotification.type.replace('_', ' ').toUpperCase() : 'Notification'"></strong>
                <button @click.stop="popupShow = false; if(currentNotification) markPopupShown(currentNotification.id)" class="close-btn">&times;</button>
            </div>
            <div class="notification-popup-body" x-text="currentNotification ? currentNotification.content : ''"></div>
            <div class="notification-popup-actions">
                <button @click.stop="openReminderModal(currentNotification)" class="btn-small">Remind</button>
                <button @click.stop="markRead(currentNotification.id)" class="btn-small">Mark Read</button>
                <button @click.stop="popupShow = false; markPopupShown(currentNotification.id)" class="btn-small">Dismiss</button>
            </div>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div id="reminder-modal"
         class="reminder-modal-overlay"
         x-show="reminderShow"
         x-transition.opacity
         style="display: none;"
         x-cloak>

        <div class="reminder-modal-content" @click.outside="reminderShow = false">
            <h3>Set Reminder</h3>
            <p x-text="'Remind me about: ' + (reminderNotification ? reminderNotification.content : '')"></p>

            <div class="form-group">
                <label>Remind me at:</label>
                <input type="datetime-local" x-model="remindTime" class="form-input">
            </div>

            <div class="modal-actions">
                <button @click="reminderShow = false" class="btn-secondary">Cancel</button>
                <button @click="setReminder()" class="btn-primary">Save</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('notificationManager', () => ({
                navMenuOpen: false,
                notificationOpen: false,
                unreadCount: {{ unread_notifications_count|default(0) }},

                // Popup state
                popupShow: false,
                currentNotification: null,
                popupTimeout: null,

                // Reminder Modal state
                reminderShow: false,
                reminderNotification: null,
                remindTime: '',

                init() {
                    // Start polling
                    setInterval(() => this.pollNotifications(), 10000);
                },

                pollNotifications() {
                    fetch('/notifications/check_new')
                        .then(res => {
                            if(res.ok) return res.json();
                            return null;
                        })
                        .then(data => {
                            if (data) {
                                this.unreadCount = data.unread_count;
                                if (data.notifications && data.notifications.length > 0) {
                                    // Show the first one
                                    this.showPopup(data.notifications[0]);
                                }
                            }
                        })
                        .catch(err => console.error('Notification poll error:', err));
                },

                showPopup(notification) {
                    this.currentNotification = notification;
                    this.popupShow = true;
                    if (this.popupTimeout) clearTimeout(this.popupTimeout);
                    this.popupTimeout = setTimeout(() => {
                        this.popupShow = false;
                        if (this.currentNotification && this.currentNotification.id === notification.id) {
                            this.markPopupShown(notification.id);
                        }
                    }, 10000);
                },

                markPopupShown(id) {
                    fetch(`/notifications/mark_popup_shown/${id}`, { method: 'POST' });
                },

                markRead(id) {
                    fetch(`/notifications/mark_read/${id}`, { method: 'POST' })
                        .then(() => {
                            this.popupShow = false;
                            this.unreadCount = Math.max(0, this.unreadCount - 1);
                        });
                },

                openReminderModal(notification) {
                    this.reminderNotification = notification;
                    // Default time: 1 hour from now
                    const now = new Date();
                    now.setHours(now.getHours() + 1);
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    this.remindTime = now.toISOString().slice(0, 16);

                    this.reminderShow = true;
                    this.popupShow = false;
                    if (this.popupTimeout) clearTimeout(this.popupTimeout);
                    this.markPopupShown(notification.id);
                },

                setReminder() {
                    if (!this.remindTime || !this.reminderNotification) return;

                    // Convert local time string to UTC ISO string
                    const localDate = new Date(this.remindTime);
                    const utcDate = localDate.toISOString();

                    fetch(`/notifications/set_reminder/${this.reminderNotification.id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ remind_at: utcDate })
                    }).then(res => {
                        if (res.ok) {
                            this.reminderShow = false;
                        }
                    });
                }
            }));
        });
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        // Automatically add data-label attributes to table cells for responsive card view
        document.addEventListener('DOMContentLoaded', function() {
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, index) => {
                        if (headers[index] && !cell.hasAttribute('data-label')) {
                            cell.setAttribute('data-label', headers[index]);
                        }
                    });
                });
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
