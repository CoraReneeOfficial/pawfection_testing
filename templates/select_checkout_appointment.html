{% extends 'base.html' %}
{% block title %}Select Appointment - Checkout{% endblock %}

{% block head %}
<style>
  .quick-action-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .quick-action-buttons .button {
    flex: 1;
    padding: 1rem;
    text-align: center;
    font-size: 1.1em;
  }
  .quick-action-buttons .button i {
    margin-right: 0.5rem;
  }
  .filter-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: center;
  }
  .filter-controls .form-input {
    flex: 1;
  }
  .date-filter {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container checkout-container">
  <div class="checkout-card" style="max-width:700px;margin:auto;">
    <h2>Checkout Options</h2>
    
    <!-- Quick action buttons for Walk In and Deposit -->
    <div class="quick-action-buttons">
      <a href="{{ url_for('appointments.walk_in_appointment') }}" class="button button-primary">
        <i class="fas fa-user-plus"></i> Walk In Appointment
      </a>
      <a href="{{ url_for('appointments.deposit_payment') }}" class="button button-secondary">
        <i class="fas fa-money-bill"></i> Deposit Payment
      </a>
    </div>
    
    <h3>Select Appointment for Checkout</h3>
    
    <!-- Filter and search controls -->
    <div class="filter-controls">
      <input type="text" id="appointment-search" class="form-input" placeholder="Search by customer or dog name...">
      <button id="search-btn" class="button button-primary"><i class="fas fa-search"></i></button>
    </div>
    
    <div class="date-filter">
      <label for="date-filter">Date:</label>
      <select id="date-filter" class="form-select">
        <option value="today" selected>Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="this-week">This Week</option>
        <option value="all">All Appointments</option>
      </select>
    </div>
    <div id="appointments-container">
      {% if appointments %}
        <ul class="appointment-select-list">
          {% for appt in appointments %}
          <li class="appointment-select-item" data-customer="{{ appt.dog.owner.name|lower }}" data-dog="{{ appt.dog.name|lower }}" data-date="{{ appt.appointment_datetime.strftime('%Y-%m-%d') }}" style="margin-bottom:1em;">
            <div>
              <strong>{{ appt.dog.name }}</strong> ({{ appt.dog.owner.name }})<br>
              <span>{{ appt.appointment_datetime.strftime('%a, %b %d @ %I:%M %p') }}</span>
              {% if appt.requested_services_text %} - {{ appt.requested_services_text|service_names_from_ids }}{% endif %}
              {% if appt.groomer %}<span style="margin-left:1em;">Groomer: {{ appt.groomer.username }}</span>{% endif %}
            </div>
            <a href="{{ url_for('appointments.invoice_checkout', appointment_id=appt.id) }}" class="button button-primary" style="margin-top:0.6em;">Start Checkout</a>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p id="no-results-message">No scheduled appointments available for checkout.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initial filtering - default to today
  filterAppointmentsByDate('today');
  
  // Search functionality
  document.getElementById('appointment-search').addEventListener('input', filterAppointments);
  document.getElementById('search-btn').addEventListener('click', filterAppointments);
  
  // Date filter change
  document.getElementById('date-filter').addEventListener('change', function() {
    filterAppointmentsByDate(this.value);
  });
  
  function filterAppointments() {
    const searchTerm = document.getElementById('appointment-search').value.toLowerCase();
    const dateFilter = document.getElementById('date-filter').value;
    
    const appointments = document.querySelectorAll('.appointment-select-item');
    let visibleCount = 0;
    
    appointments.forEach(appt => {
      const customerName = appt.getAttribute('data-customer');
      const dogName = appt.getAttribute('data-dog');
      const apptDate = appt.getAttribute('data-date');
      
      // Check if appointment matches both search term and date filter
      const matchesSearch = searchTerm === '' || 
                           customerName.includes(searchTerm) || 
                           dogName.includes(searchTerm);
                           
      const matchesDate = dateFilterMatches(dateFilter, apptDate);
      
      if (matchesSearch && matchesDate) {
        appt.style.display = '';
        visibleCount++;
      } else {
        appt.style.display = 'none';
      }
    });
    
    // Show/hide no results message
    const noResultsMsg = document.getElementById('no-results-message');
    if (noResultsMsg) {
      if (visibleCount === 0) {
        noResultsMsg.style.display = '';
        noResultsMsg.textContent = 'No appointments found matching your search criteria.';
      } else {
        noResultsMsg.style.display = 'none';
      }
    }
  }
  
  function filterAppointmentsByDate(dateFilter) {
    // Update the select value
    document.getElementById('date-filter').value = dateFilter;
    
    // Apply filtering
    filterAppointments();
  }
  
  function dateFilterMatches(filterValue, appointmentDate) {
    if (filterValue === 'all') return true;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const apptDate = new Date(appointmentDate);
    apptDate.setHours(0, 0, 0, 0);
    
    switch(filterValue) {
      case 'today':
        return apptDate.getTime() === today.getTime();
        
      case 'yesterday':
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        return apptDate.getTime() === yesterday.getTime();
        
      case 'this-week':
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
        
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6); // End of week (Saturday)
        
        return apptDate >= startOfWeek && apptDate <= endOfWeek;
        
      default:
        return true;
    }
  }
});
</script>
{% endblock %}
