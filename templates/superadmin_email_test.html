{% extends 'base.html' %}

{% block title %}Email Test - Superadmin Tools{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .email-section {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.75rem;
    }
    .section-title h2 {
        margin: 0;
        font-size: 1.5rem;
    }
    .section-icon {
        background-color: #f0f4ff;
        color: #4c6ef5;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }
    .form-column {
        flex: 1;
        min-width: 200px;
    }
    .input-field {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
    }
    .input-field:focus {
        border-color: #4c6ef5;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(76, 110, 245, 0.25);
    }
    .textarea-field {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
        min-height: 100px;
        resize: vertical;
    }
    .test-result {
        margin: 1.5rem 0;
        padding: 1rem;
        border-radius: 4px;
        display: flex;
        align-items: center;
    }
    .test-result-success {
        background-color: #d1e7dd;
        color: #0f5132;
        border-left: 4px solid #198754;
    }
    .test-result-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    .test-result-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
    }
    .test-message {
        flex: 1;
    }
    .test-time {
        padding: 0.25rem 0.5rem;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 4px;
        font-size: 0.875rem;
        margin-left: 1rem;
    }
    .form-switch {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #4c6ef5;
    }
    input:focus + .slider {
        box-shadow: 0 0 1px #4c6ef5;
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    .tab-container {
        margin-top: 1.5rem;
    }
    .tab-buttons {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    .tab-button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
        color: #495057;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
    }
    .tab-button.active {
        color: #4c6ef5;
        border-bottom-color: #4c6ef5;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .template-select {
        margin-bottom: 1.5rem;
    }
    .template-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .template-card:hover {
        background-color: #e9ecef;
        border-color: #ced4da;
    }
    .template-card.selected {
        background-color: #e8f0fe;
        border-color: #4c6ef5;
    }
    .template-name {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    .template-subject {
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    .template-preview {
        color: #6c757d;
        font-size: 0.85rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .email-preview {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1.5rem;
        background-color: #f8f9fa;
        margin-bottom: 1.5rem;
    }
    .email-preview-header {
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    .email-preview-field {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    .email-preview-field strong {
        display: inline-block;
        width: 80px;
    }
    .email-preview-content {
        font-family: Arial, sans-serif;
        line-height: 1.5;
        padding: 1rem;
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 4px;
    }
    .info-alert {
        background-color: #cfe2ff;
        color: #084298;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #0d6efd;
    }
    .password-field-wrapper {
        position: relative;
    }
    .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="logo-image-login">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Pawfection Grooming Solutions Logo" style="max-width: 350px; margin-bottom: 1rem; align-items:center;">
</div>
<div class="form-wrapper" style="max-width: 1200px;">
    <div class="form-container" style="padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h1 class="form-title">Email Test</h1>
            <div>
                <a href="/superadmin/tools" class="button button-secondary">Back to Tools</a>
            </div>
        </div>
        
        <div class="info-alert">
            <strong><i class="fas fa-info-circle"></i> Note:</strong> Configure your SMTP settings before testing email functionality. For security, never use production credentials for testing.
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button type="button" class="tab-button active" data-tab="test-email-tab">Test Email</button>
                <button type="button" class="tab-button" data-tab="email-config-tab">Email Configuration</button>
            </div>
            
            <!-- Test Email Tab -->
            <div id="test-email-tab" class="tab-content active">
                <div class="email-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-paper-plane"></i></div>
                        <h2>Send Test Email</h2>
                    </div>
                    
                    {% if test_result %}
                    <div class="test-result test-result-{{ test_result }}">
                        <div class="test-result-icon">
                            {% if test_result == 'success' %}
                                <i class="fas fa-check-circle"></i>
                            {% else %}
                                <i class="fas fa-exclamation-circle"></i>
                            {% endif %}
                        </div>
                        <div class="test-message">{{ test_message }}</div>
                        {% if test_time %}
                            <div class="test-time">{{ test_time }} seconds</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <form action="/superadmin/email-test" method="POST" id="test-email-form">
                        <input type="hidden" name="action" value="test_email">
                        
                        <div class="template-select">
                            <label class="form-label">Choose a Template</label>
                            <div class="template-container">
                                {% for template in email_templates %}
                                <div class="template-card" data-subject="{{ template.subject }}" data-body="{{ template.body }}">
                                    <div class="template-name">{{ template.name }}</div>
                                    <div class="template-subject">{{ template.subject }}</div>
                                    <div class="template-preview">{{ template.body }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="test_recipient" class="form-label">Recipient Email *</label>
                            <input type="email" id="test_recipient" name="test_recipient" class="input-field" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="test_subject" class="form-label">Email Subject</label>
                            <input type="text" id="test_subject" name="test_subject" class="input-field" value="Email Test from Pawfection">
                        </div>
                        
                        <div class="form-group">
                            <label for="test_body" class="form-label">Email Body</label>
                            <textarea id="test_body" name="test_body" class="textarea-field">This is a test email from Pawfection Grooming Solutions.</textarea>
                        </div>
                        
                        <div class="email-preview">
                            <h3>Email Preview</h3>
                            <div class="email-preview-header">
                                <div class="email-preview-field">
                                    <strong>From:</strong> {{ email_config.from_name }} &lt;{{ email_config.from_email }}&gt;
                                </div>
                                <div class="email-preview-field">
                                    <strong>To:</strong> <span id="preview_recipient">recipient@example.com</span>
                                </div>
                                <div class="email-preview-field">
                                    <strong>Subject:</strong> <span id="preview_subject">Email Test from Pawfection</span>
                                </div>
                            </div>
                            <div class="email-preview-content">
                                <h2 style="color: #4c6ef5;">Email Test from Pawfection</h2>
                                <p id="preview_body">This is a test email from Pawfection Grooming Solutions.</p>
                                <hr>
                                <p style="color: #6c757d; font-size: 0.8rem;">This is a test email sent from the Pawfection Grooming Solutions admin panel.</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end;">
                            <button type="submit" class="button button-primary">Send Test Email</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Email Configuration Tab -->
            <div id="email-config-tab" class="tab-content">
                <div class="email-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-cog"></i></div>
                        <h2>Email Configuration</h2>
                    </div>
                    
                    <form action="/superadmin/email-test" method="POST" id="email-config-form">
                        <input type="hidden" name="action" value="save_config">
                        
                        <div class="form-row">
                            <div class="form-column">
                                <label for="smtp_server" class="form-label">SMTP Server</label>
                                <input type="text" id="smtp_server" name="smtp_server" class="input-field" value="{{ email_config.smtp_server }}">
                            </div>
                            <div class="form-column">
                                <label for="smtp_port" class="form-label">SMTP Port</label>
                                <input type="number" id="smtp_port" name="smtp_port" class="input-field" value="{{ email_config.smtp_port }}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-switch">
                                <label class="switch">
                                    <input type="checkbox" name="use_tls" {% if email_config.use_tls %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                                <span>Use TLS</span>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-column">
                                <label for="smtp_username" class="form-label">SMTP Username</label>
                                <input type="text" id="smtp_username" name="smtp_username" class="input-field" value="{{ email_config.smtp_username }}">
                            </div>
                            <div class="form-column">
                                <label for="smtp_password" class="form-label">SMTP Password</label>
                                <div class="password-field-wrapper">
                                    <input type="password" id="smtp_password" name="smtp_password" class="input-field" placeholder="{% if email_config.smtp_password %}Password saved (leave empty to keep current){% else %}Enter password{% endif %}">
                                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-column">
                                <label for="from_email" class="form-label">From Email</label>
                                <input type="email" id="from_email" name="from_email" class="input-field" value="{{ email_config.from_email }}">
                            </div>
                            <div class="form-column">
                                <label for="from_name" class="form-label">From Name</label>
                                <input type="text" id="from_name" name="from_name" class="input-field" value="{{ email_config.from_name }}">
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                            <button type="reset" class="button button-secondary">Reset Changes</button>
                            <button type="submit" class="button button-primary">Save Configuration</button>
                        </div>
                    </form>
                </div>
                
                <div class="email-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-question-circle"></i></div>
                        <h2>Common SMTP Settings</h2>
                    </div>
                    
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>Provider</th>
                                <th>SMTP Server</th>
                                <th>Port</th>
                                <th>TLS</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Gmail</td>
                                <td>smtp.gmail.com</td>
                                <td>587</td>
                                <td>Yes</td>
                                <td>Requires app password for 2FA accounts</td>
                            </tr>
                            <tr>
                                <td>Outlook/Office365</td>
                                <td>smtp.office365.com</td>
                                <td>587</td>
                                <td>Yes</td>
                                <td>Use your full email address as username</td>
                            </tr>
                            <tr>
                                <td>Yahoo Mail</td>
                                <td>smtp.mail.yahoo.com</td>
                                <td>587</td>
                                <td>Yes</td>
                                <td>Requires app password</td>
                            </tr>
                            <tr>
                                <td>Zoho Mail</td>
                                <td>smtp.zoho.com</td>
                                <td>587</td>
                                <td>Yes</td>
                                <td>Use your full email address as username</td>
                            </tr>
                            <tr>
                                <td>AWS SES</td>
                                <td>email-smtp.us-east-1.amazonaws.com</td>
                                <td>587</td>
                                <td>Yes</td>
                                <td>Region may differ, use SMTP credentials from AWS console</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked button and corresponding content
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Template selection functionality
        const templateCards = document.querySelectorAll('.template-card');
        templateCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selected class from all cards
                templateCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected class to clicked card
                this.classList.add('selected');
                
                // Update form fields with template data
                const subject = this.getAttribute('data-subject');
                const body = this.getAttribute('data-body');
                
                document.getElementById('test_subject').value = subject;
                document.getElementById('test_body').value = body;
                
                // Update preview
                document.getElementById('preview_subject').textContent = subject;
                document.getElementById('preview_body').textContent = body;
            });
        });
        
        // Live preview for recipient, subject, and body
        document.getElementById('test_recipient').addEventListener('input', function() {
            document.getElementById('preview_recipient').textContent = this.value || 'recipient@example.com';
        });
        
        document.getElementById('test_subject').addEventListener('input', function() {
            document.getElementById('preview_subject').textContent = this.value;
        });
        
        document.getElementById('test_body').addEventListener('input', function() {
            document.getElementById('preview_body').textContent = this.value;
        });
        
        // Confirmation before test email submission
        document.getElementById('test-email-form').addEventListener('submit', function(e) {
            const recipient = document.getElementById('test_recipient').value;
            if (!confirm(`Are you sure you want to send a test email to ${recipient}?`)) {
                e.preventDefault();
            }
        });
        
        // Confirmation before saving email configuration
        document.getElementById('email-config-form').addEventListener('submit', function(e) {
            if (!confirm('Are you sure you want to save these email configuration settings?')) {
                e.preventDefault();
            }
        });
    });
    
    // Toggle password visibility
    function togglePasswordVisibility() {
        const passwordField = document.getElementById('smtp_password');
        const icon = document.querySelector('.password-toggle i');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
</script>
{% endblock %}
