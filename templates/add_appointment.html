{% extends 'base.html' %}

{% block title %}Add New Appointment{% endblock %}

{% block head %}
<style>
    /* Add any specific styles for this page if needed */
    /* For example, to ensure consistent spacing for form groups: */
    .form-group {
        margin-bottom: 1.25rem; /* Consistent bottom margin */
    }
    .form-group label {
        display: block; /* Ensure labels are on their own line */
        margin-bottom: 0.35rem; /* Space between label and input */
        font-weight: 500; /* Slightly bolder labels */
    }
    .form-input, select.form-input, textarea.form-input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border: 1px solid var(--border-color); /* Use CSS variable */
        border-radius: var(--border-radius-sm); /* Use CSS variable */
        background-color: #fff;
        box-sizing: border-box;
        font-size: 0.95rem;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .form-input:focus, select.form-input:focus, textarea.form-input:focus {
        border-color: var(--primary-color); /* Highlight focus with primary color */
        box-shadow: 0 0 0 0.2rem var(--primary-color-transparent); /* Subtle focus ring */
        outline: none;
    }
    select.form-input { /* Basic custom arrow for select */
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.7rem center;
        background-size: 1.25em 1.25em;
        padding-right: 2.5rem;
    }
    .form-button-wrapper {
        display: flex;
        gap: 1rem;
        justify-content: flex-end; /* Align buttons to the right */
        margin-top: 1.5rem; /* Space above buttons */
        padding-top: 1rem; /* Space within the wrapper */
        border-top: 1px solid var(--border-color-light); /* Separator line */
    }

    /* Service Chips Styles */
    .service-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 9999px; /* Pill shape */
        background-color: #fff;
        color: var(--text-color);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        user-select: none;
    }
    .service-chip:hover {
        background-color: var(--secondary-light);
        border-color: var(--secondary-color);
    }
    .service-chip.selected {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .service-chip .chip-icon {
        margin-left: 0.35rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-wrapper">
    <div class="form-container">
        <h2 class="form-title">Schedule New Appointment</h2>
        <p class="form-description">Enter the details for the new appointment.</p>

        {# Form submits to the add_appointment route #}
        <form method="POST" action="{{ url_for('appointments.add_appointment') }}" novalidate>

            <div class="form-group">
                <label for="dog_id">Dog *</label>
                <select name="dog_id" id="dog_id" required class="form-input">
                    <option value="" disabled {% if not appointment_data.get('dog_id') %}selected{% endif %}>-- Select a Dog --</option>
                    {# Loop through dogs passed from Flask #}
                    {% for dog in dogs %}
                        {# Check if this dog was selected in a previous failed submission #}
                        {# Ensure consistent type comparison (string to string, or int to int) #}
                        <option value="{{ dog.id }}" {% if dog.id|string == appointment_data.get('dog_id') %}selected{% endif %}>
                            {{ dog.name }} (Owner: {{ dog.owner.name }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" x-data="{ apptDate: '{{ appointment_data.get('appointment_date', today_date_iso) }}' }">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
                    <label for="appointment_date" style="margin-bottom: 0;">Date *</label>
                    <button type="button"
                            @click="apptDate = new Date().toLocaleDateString('en-CA')"
                            class="button button-small"
                            style="padding: 2px 8px; font-size: 0.75rem; background-color: var(--secondary-light); border: 1px solid var(--border-color); color: var(--text-dark); cursor: pointer; border-radius: 4px;">
                        Today
                    </button>
                </div>
                {# Pre-fill if value exists from previous submission, otherwise default to today #}
                <input type="date" id="appointment_date" name="appointment_date" required class="form-input" x-model="apptDate">
            </div>

            <div class="form-group">
                <label for="appointment_time">Time *</label>
                {# Pre-fill if value exists from previous submission #}
                <input type="time" id="appointment_time" name="appointment_time" required class="form-input" value="{{ appointment_data.get('appointment_time', '') }}">
                 <small class="text-muted">Select the start time for the appointment.</small>
            </div>

            <div class="form-group">
                <label for="groomer_id">Assign Groomer</label>
                <select name="groomer_id" id="groomer_id" class="form-input">
                    <option value="">-- Unassigned --</option> {# Option for no groomer #}
                    {# Loop through users passed from Flask #}
                    {% for user in users %}
                        {# Pre-select if value exists from previous submission #}
                        <option value="{{ user.id }}" {% if user.id|string == appointment_data.get('groomer_id') %}selected{% endif %}>
                            {{ user.username }}
                        </option>
                    {% endfor %}
                </select>
                 <small class="text-muted">Optional: Select the groomer for this appointment.</small>
            </div>

            <div class="form-group" x-data="{
                services: [
                    {% for service in services %}
                    {
                        id: '{{ service.id }}',
                        name: {{ service.name|tojson }},
                        selected: {{ 'true' if appointment_data.get('services_text') and (service.id|string in appointment_data.get('services_text').split(',')) else 'false' }}
                    },
                    {% endfor %}
                ],
                filter: ''
            }">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
                    <label id="services-label" style="margin-bottom: 0;">Requested Services</label>
                    <button type="button"
                            @click="services.forEach(s => s.selected = false)"
                            x-show="services.some(s => s.selected)"
                            class="button button-small"
                            style="padding: 2px 8px; font-size: 0.75rem; background-color: var(--secondary-light); border: 1px solid var(--border-color); color: var(--text-dark); cursor: pointer; border-radius: 4px;"
                            x-cloak>
                        Clear Selection
                    </button>
                </div>

                <!-- Search Input -->
                <div style="position: relative; margin-bottom: 0.5rem;">
                     <input type="text"
                            x-model="filter"
                            placeholder="Filter services..."
                            class="form-input"
                            style="padding-left: 2rem; font-size: 0.9rem;"
                            aria-label="Filter services">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="position: absolute; left: 0.6rem; top: 50%; transform: translateY(-50%); width: 1rem; height: 1rem; color: var(--text-muted);">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                     </svg>
                </div>

                <!-- Chips Container -->
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 300px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: #fafafa;"
                     role="group" aria-labelledby="services-label">
                    <template x-for="service in services" :key="service.id">
                        <div x-show="service.name.toLowerCase().includes(filter.toLowerCase())"
                             @click="service.selected = !service.selected"
                             @keydown.enter.prevent="service.selected = !service.selected"
                             @keydown.space.prevent="service.selected = !service.selected"
                             class="service-chip"
                             :class="{ 'selected': service.selected }"
                             role="button"
                             tabindex="0"
                             :aria-pressed="service.selected"
                             :aria-label="service.name + (service.selected ? ' (Selected)' : '')">
                            <span x-text="service.name"></span>
                            <span x-show="service.selected" class="chip-icon">&times;</span>
                            <span x-show="!service.selected" class="chip-icon" style="opacity: 0.3;">+</span>
                        </div>
                    </template>
                    <div x-show="services.filter(s => s.name.toLowerCase().includes(filter.toLowerCase())).length === 0" style="width: 100%; text-align: center; color: var(--text-muted); font-size: 0.9rem; padding: 1rem;">
                        No services found matching "<span x-text="filter"></span>"
                    </div>
                </div>

                <!-- Hidden Inputs for Form Submission -->
                <template x-for="service in services.filter(s => s.selected)" :key="'input-' + service.id">
                    <input type="hidden" name="services" :value="service.id">
                </template>

                <small class="text-muted">Click chips to select/deselect services. These will appear on the calendar.</small>
            </div>

            <div class="form-group">
                <label for="notes">Appointment Notes</label>
                {# Pre-fill if value exists from previous submission #}
                <textarea id="notes" name="notes" rows="3" class="form-input" placeholder="Optional: e.g., Owner requests specific shampoo, dog is matted">{{ appointment_data.get('notes', '') }}</textarea>
            </div>

            <p style="font-size: 0.8rem; color: var(--text-muted);">* Required fields</p>

            <div class="form-button-wrapper">
                 {# Cancel button goes back to the main calendar view #}
                 {# Corrected url_for to 'calendar_view' #}
                 <a href="{{ url_for('appointments.calendar_view') }}" class="button button-secondary">Cancel</a>
                <button type="submit" class="button button-primary">Schedule Appointment</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
