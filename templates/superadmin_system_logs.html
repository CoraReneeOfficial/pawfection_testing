{% extends 'base.html' %}

{% block title %}System Logs - Superadmin Tools{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .logs-section {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.75rem;
    }
    .section-title h2 {
        margin: 0;
        font-size: 1.5rem;
    }
    .section-icon {
        background-color: #f0f4ff;
        color: #4c6ef5;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
    }
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 6px;
    }
    .filter-group {
        display: flex;
        align-items: center;
    }
    .filter-group label {
        margin-right: 0.5rem;
        font-weight: 500;
    }
    .filter-group select,
    .filter-group input {
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    .stats-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .stat-card {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        flex: 1;
        min-width: 120px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.875rem;
    }
    .log-table {
        width: 100%;
        border-collapse: collapse;
    }
    .log-table th,
    .log-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
        text-align: left;
    }
    .log-table th {
        background-color: #f8f9fa;
        font-weight: 500;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .log-table-container {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .pagination {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
        gap: 0.25rem;
    }
    .pagination li {
        margin: 0;
    }
    .pagination li a,
    .pagination li span {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        color: #495057;
        text-decoration: none;
    }
    .pagination li.active a {
        background-color: #4c6ef5;
        color: white;
        border-color: #4c6ef5;
    }
    .pagination li.disabled span {
        color: #6c757d;
        cursor: not-allowed;
    }
    .pagination li:not(.active):not(.disabled) a:hover {
        background-color: #e9ecef;
    }
    .level-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        border-radius: 10rem;
        font-size: 75%;
        font-weight: 700;
    }
    .level-INFO {
        background-color: #cfe2ff;
        color: #084298;
    }
    .level-WARNING {
        background-color: #fff3cd;
        color: #856404;
    }
    .level-ERROR {
        background-color: #f8d7da;
        color: #721c24;
    }
    .level-DEBUG {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    .timestamp-cell {
        white-space: nowrap;
    }
    .source-cell {
        white-space: nowrap;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .message-cell {
        min-width: 400px;
        max-width: 600px;
        word-break: break-word;
    }
    .highlight {
        background-color: #ffff99;
        padding: 0.1rem 0.2rem;
        border-radius: 2px;
    }
    .no-logs {
        padding: 3rem;
        text-align: center;
        color: #6c757d;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    .search-container {
        display: flex;
        gap: 0.5rem;
        flex: 1;
    }
    .search-container input {
        flex: 1;
    }
    .refresh-btn {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .refresh-icon {
        display: inline-block;
    }
    .refresh-btn.loading .refresh-icon {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="logo-image-login">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Pawfection Grooming Solutions Logo" style="max-width: 350px; margin-bottom: 1rem; align-items:center;">
</div>
<div class="form-wrapper" style="max-width: 1200px;">
    <div class="form-container" style="padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h1 class="form-title">System Logs</h1>
            <div>
                <a href="/superadmin/tools" class="button button-secondary">Back to Tools</a>
                <button id="refresh-logs" class="button button-primary refresh-btn" onclick="refreshLogs()">
                    <span class="refresh-icon"><i class="fas fa-sync-alt"></i></span> Refresh
                </button>
            </div>
        </div>
        
        <div class="logs-section">
            <div class="section-title">
                <div class="section-icon"><i class="fas fa-list-alt"></i></div>
                <h2>System Logs</h2>
            </div>
            
            <form id="log-filter-form" action="/superadmin/system-logs" method="GET">
                <div class="filter-container">
                    <div class="filter-group">
                        <label for="type">Log Type:</label>
                        <select id="type" name="type" onchange="this.form.submit()">
                            {% for log_type_option in log_types %}
                                <option value="{{ log_type_option }}" {% if log_type == log_type_option %}selected{% endif %}>
                                    {{ log_type_option|title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="level">Level:</label>
                        <select id="level" name="level" onchange="this.form.submit()">
                            {% for level_option in log_levels %}
                                <option value="{{ level_option }}" {% if level == level_option %}selected{% endif %}>
                                    {{ level_option|title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="date_range">Date Range:</label>
                        <select id="date_range" name="date_range" onchange="this.form.submit()">
                            {% for range_value, range_label in date_ranges %}
                                <option value="{{ range_value }}" {% if date_range == range_value %}selected{% endif %}>
                                    {{ range_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="search" name="search" placeholder="Search in logs..." value="{{ search_term }}">
                        <button type="submit" class="button button-primary">Search</button>
                        {% if search_term %}
                            <a href="{{ url_for('superadmin_system_logs', type=log_type, level=level, date_range=date_range) }}" class="button button-secondary">Clear</a>
                        {% endif %}
                    </div>
                </div>
            </form>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value">{{ total_logs }}</div>
                    <div class="stat-label">Total Logs</div>
                </div>
                
                {% for level_name, count in level_counts.items() %}
                <div class="stat-card">
                    <div class="stat-value">{{ count }}</div>
                    <div class="stat-label">{{ level_name }} Logs</div>
                </div>
                {% endfor %}
            </div>
            
            <div class="log-table-container">
                {% if logs|length > 0 %}

                {# START: Fix for XSS vulnerability - pre-calculate safe replacement for search term #}
                {% if search_term %}
                    {% set escaped_term = search_term|e %}
                    {% set replacement = '<span class="highlight">{}</span>'.format(escaped_term)|safe %}
                {% endif %}
                {# END: Fix for XSS vulnerability #}

                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Level</th>
                            <th>Message</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td class="timestamp-cell">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                <span class="level-badge level-{{ log.level }}">{{ log.level }}</span>
                            </td>
                            <td class="message-cell">
                                {% if search_term %}
                                    {{ (log.message|e).replace(escaped_term, replacement) }}
                                {% else %}
                                    {{ log.message }}
                                {% endif %}
                            </td>
                            <td class="source-cell" title="{{ log.source }}">{{ log.source }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="no-logs">
                    <i class="fas fa-info-circle fa-3x" style="margin-bottom: 1rem;"></i>
                    <h3>No logs found</h3>
                    <p>No log entries match your current filters.</p>
                </div>
                {% endif %}
            </div>
            
            {% if total_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination-info">
                    Showing {{ ((page - 1) * 50) + 1 }}-{{ ((page - 1) * 50) + logs|length }} of {{ total_logs }} logs
                </div>
                <ul class="pagination">
                    <li {% if page == 1 %}class="disabled"{% endif %}>
                        {% if page > 1 %}
                        <a href="{{ url_for('superadmin_system_logs', type=log_type, level=level, date_range=date_range, search=search_term, page=page-1) }}">Previous</a>
                        {% else %}
                        <span>Previous</span>
                        {% endif %}
                    </li>
                    
                    {% set start_page = [1, page - 2]|max %}
                    {% set end_page = [start_page + 4, total_pages]|min %}
                    {% if end_page - start_page < 4 %}
                        {% set start_page = [end_page - 4, 1]|max %}
                    {% endif %}
                    
                    {% for p in range(start_page, end_page + 1) %}
                    <li {% if p == page %}class="active"{% endif %}>
                        <a href="{{ url_for('superadmin_system_logs', type=log_type, level=level, date_range=date_range, search=search_term, page=p) }}">{{ p }}</a>
                    </li>
                    {% endfor %}
                    
                    <li {% if page == total_pages %}class="disabled"{% endif %}>
                        {% if page < total_pages %}
                        <a href="{{ url_for('superadmin_system_logs', type=log_type, level=level, date_range=date_range, search=search_term, page=page+1) }}">Next</a>
                        {% else %}
                        <span>Next</span>
                        {% endif %}
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Highlight search terms
        if ('{{ search_term }}') {
            highlightSearchTerm('{{ search_term }}');
        }
    });
    
    function highlightSearchTerm(term) {
        if (!term) return;
        
        const messages = document.querySelectorAll('.message-cell');
        const regex = new RegExp(term, 'gi');
        
        messages.forEach(message => {
            if (!message.innerHTML.includes('highlight')) {
                message.innerHTML = message.innerHTML.replace(
                    regex, 
                    match => `<span class="highlight">${match}</span>`
                );
            }
        });
    }
    
    function refreshLogs() {
        const refreshBtn = document.getElementById('refresh-logs');
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
        
        // Reload the current page
        location.reload();
    }
</script>
{% endblock %}
