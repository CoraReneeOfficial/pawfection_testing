{% extends 'base.html' %}

{% block title %}{{ 'Add New User' if mode == 'add' else 'Edit User: ' + user_data.username }}{% endblock %}

{% block head %}
<style>
    .form-group-inline {
        display: flex;
        align-items: center;
        gap: 0.75rem; 
        margin-bottom: 1rem; 
    }
    .form-group-inline input[type="checkbox"] {
        width: auto; 
        height: auto;
        margin-top: 0; 
    }
    .form-group-inline label {
        margin-bottom: 0; 
        font-weight: normal; 
    }
</style>
{% endblock %}

{% block content %}
<div class="form-wrapper">
    <div class="form-container form-container-sm">
        <h2 class="form-title">{{ 'Add New User' if mode == 'add' else 'Edit User: ' + user_data.username }}</h2>

        <form method="POST" action="{{ url_for('management.add_user') if mode == 'add' else url_for('management.edit_user', user_id=user_data.id) }}" enctype="multipart/form-data" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-group">
                <label for="username">Username *</label>
                <input type="text" id="username" name="username" required class="form-input" value="{{ user_data.username or '' }}" autofocus>
            </div>
            <div class="form-group" x-data="{ showPassword: false }">
                <label for="password">Password {{ '*' if mode == 'add' else '(leave blank to keep current)' }}</label>
                <div style="position: relative;">
                    <input :type="showPassword ? 'text' : 'password'" id="password" name="password" {{ 'required' if mode == 'add' else '' }} class="form-input" style="padding-right: 2.5rem;">
                    <button type="button" @click="showPassword = !showPassword"
                            class="password-toggle-btn"
                            style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.25rem;"
                            :aria-label="showPassword ? 'Hide password' : 'Show password'">
                        <svg x-show="!showPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <svg x-show="showPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; display: none;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group" x-data="{ showPassword: false }">
                 <label for="confirm_password">Confirm Password {{ '*' if mode == 'add' else '' }}</label>
                <div style="position: relative;">
                    <input :type="showPassword ? 'text' : 'password'" id="confirm_password" name="confirm_password" {{ 'required' if mode == 'add' else '' }} class="form-input" style="padding-right: 2.5rem;">
                    <button type="button" @click="showPassword = !showPassword"
                            class="password-toggle-btn"
                            style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.25rem;"
                            :aria-label="showPassword ? 'Hide password' : 'Show password'">
                        <svg x-show="!showPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <svg x-show="showPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; display: none;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                    </button>
                </div>
                 <small class="text-muted" style="display: block; margin-top: 0.2rem;">
                    {% if mode == 'edit' %}Only required if changing the password.{% else %}Required.{% endif %}
                 </small>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" class="form-input" value="{{ user_data.email or '' }}">
                <small class="text-muted" style="display: block; margin-top: 0.2rem;">
                    Used for account recovery. Recommended for password resets.
                </small>
            </div>

            <div class="form-group">
                <label for="security_question">Security Question</label>
                <select id="security_question" name="security_question" class="form-input" {{ 'required' if mode == 'add' else '' }}>
                    <option value="">-- Select a Question --</option>
                    <option value="What was your first pet's name?" {% if user_data.security_question == "What was your first pet's name?" %}selected{% endif %}>What was your first pet's name?</option>
                    <option value="What was the name of your elementary school?" {% if user_data.security_question == "What was the name of your elementary school?" %}selected{% endif %}>What was the name of your elementary school?</option>
                    <option value="In what city were you born?" {% if user_data.security_question == "In what city were you born?" %}selected{% endif %}>In what city were you born?</option>
                    <option value="What is your mother's maiden name?" {% if user_data.security_question == "What is your mother's maiden name?" %}selected{% endif %}>What is your mother's maiden name?</option>
                    <option value="What was the make of your first car?" {% if user_data.security_question == "What was the make of your first car?" %}selected{% endif %}>What was the make of your first car?</option>
                    <option value="What is the name of your favorite childhood friend?" {% if user_data.security_question == "What is the name of your favorite childhood friend?" %}selected{% endif %}>What is the name of your favorite childhood friend?</option>
                    <option value="What is your favorite movie?" {% if user_data.security_question == "What is your favorite movie?" %}selected{% endif %}>What is your favorite movie?</option>
                    <option value="What street did you grow up on?" {% if user_data.security_question == "What street did you grow up on?" %}selected{% endif %}>What street did you grow up on?</option>
                    <option value="What is your favorite book?" {% if user_data.security_question == "What is your favorite book?" %}selected{% endif %}>What is your favorite book?</option>
                </select>
                <small class="text-muted" style="display: block; margin-top: 0.2rem;">This will be used for account recovery if you forget your password.</small>
            </div>

            <div class="form-group">
                <label for="security_answer">Answer to Security Question</label>
                <input type="text" id="security_answer" name="security_answer" class="form-input" {{ 'required' if mode == 'add' else '' }}>
                <small class="text-muted" style="display: block; margin-top: 0.2rem;">
                    {% if mode == 'edit' %}Leave blank to keep current answer.{% else %}Required.{% endif %}
                </small>
            </div>

            <div class="form-group form-group-inline">
                <input type="checkbox" id="is_admin" name="is_admin" value="true" {% if user_data.is_admin %}checked{% endif %} style="width: auto; height: auto;">
                <label for="is_admin">Is Administrator?</label>
            </div>
            
            <div class="form-group form-group-inline">
                <input type="checkbox" id="is_groomer" name="is_groomer" value="true" {% if user_data.is_groomer %}checked{% endif %} style="width: auto; height: auto;">
                <label for="is_groomer">Is Groomer?</label>
            </div>
             <small class="text-muted" style="display: block; margin-bottom: 1rem;">
                A user can be an Administrator, a Groomer, or both. Roles are independent.
             </small>

            <div class="form-group">
                <label for="user_picture">Profile Picture</label>
                <input type="file" id="user_picture" name="user_picture" class="form-input" accept="image/png, image/jpeg, image/gif, image/webp">
                 <small class="text-muted">Optional. Uploading a new picture will replace the current one.</small>
                 {% if mode == 'edit' and user_data.picture_filename %}
                    <div style="margin-top: 0.5rem;">
                        Current picture:
                        {# MODIFIED: Use the new route for uploaded files #}
                        <img src="{{ url_for('uploaded_persistent_file', filename=user_data.picture_filename) }}" alt="Current picture for {{ user_data.username }}" style="max-height: 60px; max-width: 60px; border-radius: 50%; margin-left: 1rem; vertical-align: middle;">
                    </div>
                 {% endif %}
            </div>

            <p style="font-size: 0.8rem; color: var(--text-muted);">* Required fields</p>

            <div class="form-button-wrapper">
                 <a href="{{ url_for('management.manage_users') }}" class="button button-secondary">Cancel</a>
                <button type="submit" class="button button-primary">{{ 'Add User' if mode == 'add' else 'Save Changes' }}</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
